{% extends "base.html" %}

{% block title %}Simulate Game - NFL Football Sim{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4>Week {{ franchise.current_week }}</h4>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-5">
                        <h3>{{ user_team.name }}</h3>
                        <p class="text-muted">{{ user_team.wins }}-{{ user_team.losses }}</p>
                        <h1 id="user-score" class="display-3">0</h1>
                    </div>
                    <div class="col-md-2 d-flex align-items-center justify-content-center">
                        <h2>VS</h2>
                    </div>
                    <div class="col-md-5">
                        <h3>{{ opponent.name }}</h3>
                        <p class="text-muted">{{ opponent.wins }}-{{ opponent.losses }}</p>
                        <h1 id="opponent-score" class="display-3">0</h1>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button id="simulate-btn" class="btn btn-success btn-lg me-3" onclick="startWatchGame()">
                        Watch Game
                    </button>
                    <button id="fast-sim-btn" class="btn btn-primary btn-lg" onclick="simulateGame(true)">
                        Fast Sim
                    </button>
                    <div id="game-status" class="mt-3"></div>

                    <!-- Sim Speed Controls (hidden until watch game starts) -->
                    <div id="sim-speed-controls" class="mt-3" style="display: none;">
                        <label class="me-2 fw-bold">Sim Speed:</label>
                        <div class="btn-group" role="group">
                            <button type="button" id="speed-click" class="btn btn-sm btn-outline-secondary" onclick="setSimSpeed('click')">Click Per Play</button>
                            <button type="button" id="speed-slow" class="btn btn-sm btn-outline-secondary" onclick="setSimSpeed('slow')">Slow</button>
                            <button type="button" id="speed-normal" class="btn btn-sm btn-outline-secondary active" onclick="setSimSpeed('normal')">Normal</button>
                            <button type="button" id="speed-fast" class="btn btn-sm btn-outline-secondary" onclick="setSimSpeed('fast')">Fast</button>
                        </div>
                        <button id="next-play-btn" class="btn btn-sm btn-primary ms-3" style="display: none;" onclick="advancePlay()">Next Play ‚Üí</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Opponent Preview -->
        <div class="card mb-4" id="opponent-preview">
            <div class="card-header bg-secondary text-white">
                <h5>Matchup Preview</h5>
            </div>
            <div class="card-body">
                <!-- Team Ratings -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-center mb-3">Team Ratings</h6>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary">{{ user_team.name }}</h6>
                        <div class="mb-2">
                            <small>Pass Offense: {{ user_ratings.pass_off }}/99</small>
                            <div class="progress">
                                <div class="progress-bar bg-info" style="width: {{ user_ratings.pass_off }}%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <small>Rush Offense: {{ user_ratings.rush_off }}/99</small>
                            <div class="progress">
                                <div class="progress-bar bg-success" style="width: {{ user_ratings.rush_off }}%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <small>Pass Defense: {{ user_ratings.pass_def }}/99</small>
                            <div class="progress">
                                <div class="progress-bar bg-warning" style="width: {{ user_ratings.pass_def }}%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <small>Rush Defense: {{ user_ratings.rush_def }}/99</small>
                            <div class="progress">
                                <div class="progress-bar bg-danger" style="width: {{ user_ratings.rush_def }}%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <small>Special Teams: {{ user_ratings.special_teams }}/99</small>
                            <div class="progress">
                                <div class="progress-bar bg-secondary" style="width: {{ user_ratings.special_teams }}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-danger">{{ opponent.name }}</h6>
                        <div class="mb-2">
                            <small>Pass Offense: {{ opponent_ratings.pass_off }}/99</small>
                            <div class="progress">
                                <div class="progress-bar bg-info" style="width: {{ opponent_ratings.pass_off }}%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <small>Rush Offense: {{ opponent_ratings.rush_off }}/99</small>
                            <div class="progress">
                                <div class="progress-bar bg-success" style="width: {{ opponent_ratings.rush_off }}%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <small>Pass Defense: {{ opponent_ratings.pass_def }}/99</small>
                            <div class="progress">
                                <div class="progress-bar bg-warning" style="width: {{ opponent_ratings.pass_def }}%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <small>Rush Defense: {{ opponent_ratings.rush_def }}/99</small>
                            <div class="progress">
                                <div class="progress-bar bg-danger" style="width: {{ opponent_ratings.rush_def }}%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <small>Special Teams: {{ opponent_ratings.special_teams }}/99</small>
                            <div class="progress">
                                <div class="progress-bar bg-secondary" style="width: {{ opponent_ratings.special_teams }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Team Statistics -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-center mb-3">Team Statistics</h6>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td>Points/Game</td>
                                    <td class="text-end"><strong>{{ user_stats.ppg }}</strong></td>
                                </tr>
                                <tr>
                                    <td>Points Allowed/Game</td>
                                    <td class="text-end"><strong>{{ user_stats.papg }}</strong></td>
                                </tr>
                                <tr>
                                    <td>Pass Yards/Game</td>
                                    <td class="text-end">{{ user_stats.pass_ypg }}</td>
                                </tr>
                                <tr>
                                    <td>Pass Yards Allowed/Game</td>
                                    <td class="text-end">{{ user_stats.pass_yapg }}</td>
                                </tr>
                                <tr>
                                    <td>Pass TDs (For/Against)</td>
                                    <td class="text-end">{{ user_stats.pass_tds_for }}/{{ user_stats.pass_tds_against }}</td>
                                </tr>
                                <tr>
                                    <td>Rush Yards/Game</td>
                                    <td class="text-end">{{ user_stats.rush_ypg }}</td>
                                </tr>
                                <tr>
                                    <td>Rush Yards Allowed/Game</td>
                                    <td class="text-end">{{ user_stats.rush_yapg }}</td>
                                </tr>
                                <tr>
                                    <td>Rush TDs (For/Against)</td>
                                    <td class="text-end">{{ user_stats.rush_tds_for }}/{{ user_stats.rush_tds_against }}</td>
                                </tr>
                                <tr>
                                    <td>FG Percentage</td>
                                    <td class="text-end">{{ user_stats.fg_pct }}%</td>
                                </tr>
                                <tr>
                                    <td>Longest FG</td>
                                    <td class="text-end">{{ user_stats.longest_fg }} yds</td>
                                </tr>
                                <tr>
                                    <td>Avg Punt Distance</td>
                                    <td class="text-end">{{ user_stats.avg_punt }} yds</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td>Points/Game</td>
                                    <td class="text-end"><strong>{{ opponent_stats.ppg }}</strong></td>
                                </tr>
                                <tr>
                                    <td>Points Allowed/Game</td>
                                    <td class="text-end"><strong>{{ opponent_stats.papg }}</strong></td>
                                </tr>
                                <tr>
                                    <td>Pass Yards/Game</td>
                                    <td class="text-end">{{ opponent_stats.pass_ypg }}</td>
                                </tr>
                                <tr>
                                    <td>Pass Yards Allowed/Game</td>
                                    <td class="text-end">{{ opponent_stats.pass_yapg }}</td>
                                </tr>
                                <tr>
                                    <td>Pass TDs (For/Against)</td>
                                    <td class="text-end">{{ opponent_stats.pass_tds_for }}/{{ opponent_stats.pass_tds_against }}</td>
                                </tr>
                                <tr>
                                    <td>Rush Yards/Game</td>
                                    <td class="text-end">{{ opponent_stats.rush_ypg }}</td>
                                </tr>
                                <tr>
                                    <td>Rush Yards Allowed/Game</td>
                                    <td class="text-end">{{ opponent_stats.rush_yapg }}</td>
                                </tr>
                                <tr>
                                    <td>Rush TDs (For/Against)</td>
                                    <td class="text-end">{{ opponent_stats.rush_tds_for }}/{{ opponent_stats.rush_tds_against }}</td>
                                </tr>
                                <tr>
                                    <td>FG Percentage</td>
                                    <td class="text-end">{{ opponent_stats.fg_pct }}%</td>
                                </tr>
                                <tr>
                                    <td>Longest FG</td>
                                    <td class="text-end">{{ opponent_stats.longest_fg }} yds</td>
                                </tr>
                                <tr>
                                    <td>Avg Punt Distance</td>
                                    <td class="text-end">{{ opponent_stats.avg_punt }} yds</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Top Players -->
                <div class="row">
                    <div class="col-12">
                        <h6 class="text-center mb-3">Top Players</h6>
                    </div>
                    <div class="col-md-6">
                        {% for player in user_top_players %}
                        <div class="mb-2">
                            <strong>{{ player.position }}</strong>: {{ player.name }} ({{ player.skill }})
                            <br>
                            <small class="text-muted">{{ player.stats_line }}</small>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        {% for player in opponent_top_players %}
                        <div class="mb-2">
                            <strong>{{ player.position }}</strong>: {{ player.name }} ({{ player.skill }})
                            <br>
                            <small class="text-muted">{{ player.stats_line }}</small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Play-by-Play -->
        <div class="card" id="playbyplay-card" style="display: none;">
            <div class="card-header bg-dark text-white">
                <h5>Play-by-Play</h5>
            </div>
            <div class="card-body">
                <!-- Field Position Visualization -->
                <div id="field-position" class="mb-3 p-3 border rounded" style="background: linear-gradient(to right, #28a745 0%, #28a745 5%, #e8f5e9 5%, #e8f5e9 95%, #dc3545 95%, #dc3545 100%); overflow-x: auto;">
                    <div id="field-display" class="text-center" style="font-family: 'Courier New', monospace;"></div>
                </div>

                <div id="playbyplay" style="max-height: 600px; overflow-y: auto; font-family: monospace; font-size: 14px;">
                </div>
            </div>
        </div>

        <!-- Post-Game Player Stats -->
        <div class="card mt-4" id="postgame-stats-card" style="display: none;">
            <div class="card-header bg-success text-white">
                <h5>Game Stats</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- User Team Stats -->
                    <div class="col-md-6">
                        <h6 class="text-center mb-3">{{ user_team.name }}</h6>
                        <div style="max-height: 500px; overflow-y: auto; font-size: 13px;">
                            <div id="user-team-stats"></div>
                        </div>
                    </div>

                    <!-- Opponent Stats -->
                    <div class="col-md-6">
                        <h6 class="text-center mb-3">{{ opponent.name }}</h6>
                        <div style="max-height: 500px; overflow-y: auto; font-size: 13px;">
                            <div id="opponent-team-stats"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let playIndex = 0;
let plays = [];
let intervalId = null;
let gameData = null;
let currentOffense = null;
let userScore = 0;
let opponentScore = 0;
let currentFieldPosition = 25;
let currentSimSpeed = 'normal';
const userTeamName = "{{ user_team.name }}";
const opponentTeamName = "{{ opponent.name }}";
const userTeamAbbrev = getTeamAbbrev(userTeamName);
const opponentTeamAbbrev = getTeamAbbrev(opponentTeamName);

function getTeamAbbrev(teamName) {
    const words = teamName.split(' ');
    if (words.length >= 2) {
        return words[words.length - 1].substring(0, 3).toUpperCase();
    }
    return teamName.substring(0, 3).toUpperCase();
}

function startWatchGame() {
    simulateGame(false);
}

function simulateGame(fastSim) {
    const btn = document.getElementById('simulate-btn');
    const fastBtn = document.getElementById('fast-sim-btn');
    const status = document.getElementById('game-status');
    const preview = document.getElementById('opponent-preview');
    const playbyplayCard = document.getElementById('playbyplay-card');
    const speedControls = document.getElementById('sim-speed-controls');

    btn.disabled = true;
    fastBtn.disabled = true;
    btn.textContent = 'Simulating...';
    fastBtn.textContent = 'Simulating...';
    status.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';

    // Hide preview
    preview.style.display = 'none';

    // Reset scores
    userScore = 0;
    opponentScore = 0;
    currentOffense = null;
    document.getElementById('user-score').textContent = '0';
    document.getElementById('opponent-score').textContent = '0';

    // Call API to simulate game
    fetch('/api/simulate-game', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ fast_sim: fastSim })
    })
    .then(response => response.json())
    .then(data => {
        gameData = data;
        plays = data.plays || [];
        playIndex = 0;

        if (plays.length === 0) {
            // No plays - just show results
            showGameResults(data);
        } else {
            // Show play-by-play
            playbyplayCard.style.display = 'block';

            if (!fastSim) {
                // Show speed controls for watch game
                speedControls.style.display = 'block';
                startPlayback();
            } else {
                // Fast sim
                const delay = 10;
                intervalId = setInterval(displayNextPlay, delay);
            }

            status.textContent = 'Game in progress...';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        status.innerHTML = '<div class="alert alert-danger">Error simulating game</div>';
        btn.disabled = false;
        fastBtn.disabled = false;
        btn.textContent = 'Watch Game';
        fastBtn.textContent = 'Fast Sim';
    });
}

function startPlayback() {
    if (currentSimSpeed === 'click') {
        // Manual mode - show next play button
        document.getElementById('next-play-btn').style.display = 'inline-block';
    } else {
        // Automatic playback
        document.getElementById('next-play-btn').style.display = 'none';
        let delay = 200; // normal
        if (currentSimSpeed === 'slow') delay = 500;
        else if (currentSimSpeed === 'fast') delay = 50;

        intervalId = setInterval(displayNextPlay, delay);
    }
}

function setSimSpeed(speed) {
    currentSimSpeed = speed;

    // Update button states
    document.querySelectorAll('#sim-speed-controls .btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById(`speed-${speed}`).classList.add('active');

    // Restart playback with new speed
    if (intervalId) {
        clearInterval(intervalId);
    }
    startPlayback();
}

function advancePlay() {
    displayNextPlay();
}

function showGameResults(data) {
    document.getElementById('user-score').textContent = data.user_score;
    document.getElementById('opponent-score').textContent = data.opponent_score;

    let statusHtml = '<div class="alert alert-success"><h5>Game Complete!</h5>';
    statusHtml += `<p><strong>Final Score:</strong> {{ user_team.name }} ${data.user_score} - ${data.opponent_score} {{ opponent.name }}</p>`;

    if (data.other_games && data.other_games.length > 0) {
        statusHtml += '<hr><h6>Other Games This Week:</h6><div class="row">';
        data.other_games.forEach(game => {
            statusHtml += `<div class="col-md-6"><small>${game.team1} ${game.team1_score} - ${game.team2_score} ${game.team2}</small></div>`;
        });
        statusHtml += '</div>';
    }

    statusHtml += '</div>';

    document.getElementById('game-status').innerHTML = statusHtml;

    // Hide speed controls
    document.getElementById('sim-speed-controls').style.display = 'none';

    // Show post-game stats
    displayPostGameStats(data);

    // Enable button to continue
    setTimeout(() => {
        const btn = document.getElementById('simulate-btn');
        btn.textContent = 'Return to Home';
        btn.disabled = false;
        btn.onclick = () => window.location.href = "{{ url_for('index') }}";
    }, 1000);
}

function displayPostGameStats(data) {
    // Show the stats card
    document.getElementById('postgame-stats-card').style.display = 'block';

    // Fetch and display user team stats
    fetch('/api/game-stats?team={{ user_team.name }}')
        .then(response => response.json())
        .then(stats => {
            document.getElementById('user-team-stats').innerHTML = formatPlayerStats(stats);
        });

    // Fetch and display opponent stats
    fetch('/api/game-stats?team={{ opponent.name }}')
        .then(response => response.json())
        .then(stats => {
            document.getElementById('opponent-team-stats').innerHTML = formatPlayerStats(stats);
        });
}

function formatPlayerStats(players) {
    let html = '';

    // Group players by position
    const positions = ['QB', 'RB', 'WR', 'TE', 'DL', 'LB', 'CB', 'S', 'K', 'P'];

    positions.forEach(pos => {
        const posPlayers = players.filter(p => p.position === pos);
        if (posPlayers.length === 0) return;

        html += `<div class="mb-3"><strong class="text-primary">${pos}</strong><table class="table table-sm table-striped">`;

        posPlayers.forEach(player => {
            html += `<tr><td colspan="2" class="fw-bold">${player.name}</td></tr>`;

            // Passing stats
            if (player.pass_attempts > 0) {
                const comp_pct = ((player.pass_completions / player.pass_attempts) * 100).toFixed(1);
                html += `<tr><td class="ps-3">Passing:</td><td>${player.pass_completions}/${player.pass_attempts} (${comp_pct}%), ${player.pass_yards} yds, ${player.pass_td} TD, ${player.interceptions} INT</td></tr>`;
            }

            // Rushing stats
            if (player.rush_attempts > 0) {
                const rush_avg = (player.rush_yards / player.rush_attempts).toFixed(1);
                html += `<tr><td class="ps-3">Rushing:</td><td>${player.rush_attempts} att, ${player.rush_yards} yds (${rush_avg} avg), ${player.rush_td} TD</td></tr>`;
            }

            // Receiving stats
            if (player.rec_targets > 0) {
                html += `<tr><td class="ps-3">Receiving:</td><td>${player.rec_catches}/${player.rec_targets} tgt, ${player.rec_yards} yds, ${player.rec_td} TD</td></tr>`;
            }

            // Defensive stats
            if (player.tackles > 0 || player.sacks > 0) {
                html += `<tr><td class="ps-3">Defense:</td><td>${player.tackles} tkl`;
                if (player.sacks > 0) html += `, ${player.sacks} sck`;
                if (player.interceptions_def > 0) html += `, ${player.interceptions_def} int`;
                if (player.pass_deflections > 0) html += `, ${player.pass_deflections} pd`;
                if (player.forced_fumbles > 0) html += `, ${player.forced_fumbles} ff`;
                html += `</td></tr>`;
            }

            // Kicker stats
            if (player.fg_attempts > 0 || player.xp_attempts > 0) {
                html += `<tr><td class="ps-3">Kicking:</td><td>`;
                if (player.fg_attempts > 0) {
                    const fg_pct = ((player.fg_made / player.fg_attempts) * 100).toFixed(0);
                    html += `FG: ${player.fg_made}/${player.fg_attempts} (${fg_pct}%)`;
                    if (player.longest_fg > 0) html += ` Long: ${player.longest_fg}`;
                }
                if (player.xp_attempts > 0) {
                    if (player.fg_attempts > 0) html += `, `;
                    html += `XP: ${player.xp_made}/${player.xp_attempts}`;
                }
                html += `</td></tr>`;
            }

            // Punter stats
            if (player.punt_attempts > 0) {
                const punt_avg = (player.punt_yards / player.punt_attempts).toFixed(1);
                html += `<tr><td class="ps-3">Punting:</td><td>${player.punt_attempts} punts, ${player.punt_yards} yds (${punt_avg} avg)`;
                if (player.inside_20 > 0) html += `, ${player.inside_20} inside 20`;
                if (player.longest_punt > 0) html += `, Long: ${player.longest_punt}`;
                html += `</td></tr>`;
            }
        });

        html += '</table></div>';
    });

    return html;
}

function displayNextPlay() {
    if (playIndex >= plays.length) {
        if (intervalId) clearInterval(intervalId);
        showGameResults(gameData);
        return;
    }

    const play = plays[playIndex];
    const playDiv = document.getElementById('playbyplay');

    // Update field position visualization
    updateFieldPosition(play);

    // Check if this is a drive header to track which team has the ball
    if (play.includes('---') && play.includes('starts at')) {
        if (play.includes(userTeamName)) {
            currentOffense = 'user';
        } else if (play.includes(opponentTeamName)) {
            currentOffense = 'opponent';
        }
    }

    // Check for scoring plays
    if (play.includes('TOUCHDOWN!!!')) {
        if (currentOffense === 'user') {
            userScore += 7;
            document.getElementById('user-score').textContent = userScore;
        } else if (currentOffense === 'opponent') {
            opponentScore += 7;
            document.getElementById('opponent-score').textContent = opponentScore;
        }
    } else if (play.includes('GOOD!') && play.includes('Field goal')) {
        if (currentOffense === 'user') {
            userScore += 3;
            document.getElementById('user-score').textContent = userScore;
        } else if (currentOffense === 'opponent') {
            opponentScore += 3;
            document.getElementById('opponent-score').textContent = opponentScore;
        }
    }

    // Add the play to the display
    const playElement = document.createElement('div');
    playElement.textContent = play;

    // Highlight scoring plays
    if (play.includes('TOUCHDOWN!!!') || (play.includes('GOOD!') && play.includes('Field goal'))) {
        playElement.className = 'text-success fw-bold';
    }

    // Highlight drive headers
    if (play.includes('---') || play.includes('===')) {
        playElement.className = 'text-primary fw-bold mt-2';
    }

    playDiv.appendChild(playElement);

    // Auto-scroll to bottom
    playDiv.scrollTop = playDiv.scrollHeight;

    playIndex++;
}

function parseFieldPosition(play) {
    // Look for field position format like "at DET 43" or "at OWN 25" or "at 50"
    const fieldPosMatch = play.match(/at\s+(\w+)\s+(\d+)/);
    if (fieldPosMatch) {
        const zone = fieldPosMatch[1];
        const yardLine = parseInt(fieldPosMatch[2]);

        if (zone === 'OWN') {
            return yardLine;
        } else if (zone === '50') {
            return 50;
        } else {
            // Opponent territory
            return 100 - yardLine;
        }
    }
    return null;
}

function renderField() {
    const fieldDisplay = document.getElementById('field-display');

    // Determine which direction we're going
    // If user has ball, they're moving left-to-right (toward opponent endzone)
    // If opponent has ball, they're moving right-to-left (toward user endzone)
    let ballPosFromUserSide;
    let direction = '';

    if (currentOffense === 'user') {
        ballPosFromUserSide = currentFieldPosition;
        direction = '‚Üí'; // User attacking right
    } else {
        ballPosFromUserSide = 100 - currentFieldPosition;
        direction = '‚Üê'; // Opponent attacking left
    }

    // Build enhanced field visualization
    const fieldWidth = 80;
    const ballPixel = Math.floor((ballPosFromUserSide / 100) * fieldWidth);

    let topLine = `${userTeamAbbrev} ${'-'.repeat(fieldWidth)} ${opponentTeamAbbrev}`;
    let fieldLine = userTeamAbbrev + ' ';

    for (let i = 0; i < fieldWidth; i++) {
        if (i === ballPixel) {
            fieldLine += 'üèà';
        } else if (i === 0 || i === fieldWidth - 1) {
            fieldLine += '‚ïë';
        } else if (i % 10 === 0) {
            fieldLine += '‚îÇ';
        } else {
            fieldLine += '‚îÄ';
        }
    }
    fieldLine += ' ' + opponentTeamAbbrev;

    // Yard markers
    let yardLine = userTeamAbbrev + ' ';
    for (let i = 0; i < fieldWidth; i++) {
        if (i === 0) yardLine += '0';
        else if (i === fieldWidth / 2) yardLine += '50';
        else if (i === fieldWidth - 1) yardLine += '0';
        else if (i % 10 === 0) {
            const yard = Math.floor((i / fieldWidth) * 100);
            if (yard <= 50) yardLine += String(yard).padStart(2, ' ').substring(0, 1);
            else yardLine += String(100 - yard).padStart(2, ' ').substring(0, 1);
        } else yardLine += ' ';
    }
    yardLine += ' ' + opponentTeamAbbrev;

    // Position info
    let posInfo = '';
    if (currentFieldPosition === 50) {
        posInfo = `${direction} Ball at 50 yard line`;
    } else {
        const offense = currentOffense === 'user' ? userTeamAbbrev : opponentTeamAbbrev;
        const defense = currentOffense === 'user' ? opponentTeamAbbrev : userTeamAbbrev;
        const yardsToGoal = 100 - currentFieldPosition;

        if (currentFieldPosition < 50) {
            posInfo = `${direction} ${offense} has ball at ${offense} ${currentFieldPosition} (${yardsToGoal} yds to goal)`;
        } else {
            posInfo = `${direction} ${offense} has ball at ${defense} ${100 - currentFieldPosition} (${yardsToGoal} yds to goal)`;
        }
    }

    fieldDisplay.innerHTML = `
        <div style="font-size: 12px; line-height: 1.6;">
            <div style="color: #666;">${topLine}</div>
            <div style="font-size: 16px; font-weight: bold; color: #000;">${fieldLine}</div>
            <div style="color: #666; font-size: 10px;">${yardLine}</div>
            <div style="margin-top: 8px; font-size: 13px; font-weight: bold; color: #333;">${posInfo}</div>
        </div>
    `;
}

function updateFieldPosition(play) {
    // Update field position based on play description
    const newPos = parseFieldPosition(play);
    if (newPos !== null) {
        currentFieldPosition = newPos;
        renderField();
    }

    // Check for drive headers to update offense/defense
    if (play.includes('---') && play.includes('starts at')) {
        if (play.includes(userTeamName)) {
            currentOffense = 'user';
        } else if (play.includes(opponentTeamName)) {
            currentOffense = 'opponent';
        }
        renderField();
    }
}
</script>
{% endblock %}
